plugins {
	id 'java'
	id 'org.springframework.boot' version '3.5.7'
	id 'io.spring.dependency-management' version '1.1.7'
}

group = 'com.example'
version = '0.0.1-SNAPSHOT'
description = 'Demo project for Spring Boot'

java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(17)
	}
}

repositories {
	mavenCentral()
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'org.springframework.boot:spring-boot-starter-validation'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	developmentOnly 'org.springframework.boot:spring-boot-docker-compose'
	runtimeOnly 'org.postgresql:postgresql'
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.3.0'  // –≠—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏ —Å–æ–∑–¥–∞—ë—Ç Swagger UI
	implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
    runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.5'
    runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.11.5'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.springframework.security:spring-security-test'
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

tasks.named('test') {
	useJUnitPlatform()
}

task exportProject {
    group = 'documentation'
    description = '–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∫–æ–¥ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª'

    doLast {
        def projectRoot = project.projectDir
        def timestamp = new Date().format('yyyyMMdd_HHmmss')
        def outputFile = new File(projectRoot, "project_export_${timestamp}.txt")

        def includeExtensions = ['.java', '.gradle', '.properties', '.yml', '.yaml',
                                 '.xml', '.md', '.txt', '.sql', '.json']

        def excludeDirs = ['.gradle', 'build', 'bin', 'out', '.git',
                          '.idea', 'target', 'node_modules', '.vscode']

        outputFile.withWriter('UTF-8') { writer ->
            writer.println('=' * 80)
            writer.println('–≠–ö–°–ü–û–†–¢ –ü–†–û–ï–ö–¢–ê')
            writer.println("–î–∞—Ç–∞: ${new Date().format('yyyy-MM-dd HH:mm:ss')}")
            writer.println("–ü—É—Ç—å: ${projectRoot}")
            writer.println('=' * 80)
            writer.println()

            writer.println('=' * 80)
            writer.println('–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê')
            writer.println('=' * 80)

            def printTree
            printTree = { File dir, String prefix, Writer w ->
                def files = dir.listFiles()?.toList()?.sort { a, b ->
                    if (a.isDirectory() != b.isDirectory()) {
                        return a.isDirectory() ? -1 : 1
                    }
                    return a.name.compareToIgnoreCase(b.name)
                }

                files?.eachWithIndex { file, index ->
                    if (excludeDirs.contains(file.name)) return

                    def isLast = index == files.size() - 1
                    def connector = isLast ? '‚îî‚îÄ‚îÄ ' : '‚îú‚îÄ‚îÄ '
                    w.println("${prefix}${connector}${file.name}")

                    if (file.isDirectory()) {
                        def extension = isLast ? '    ' : '‚îÇ   '
                        printTree(file, prefix + extension, w)
                    }
                }
            }

            writer.println("${projectRoot.name}/")
            printTree(projectRoot, '', writer)
            writer.println()
            writer.println()

            writer.println('=' * 80)
            writer.println('–°–û–î–ï–†–ñ–ò–ú–û–ï –§–ê–ô–õ–û–í')
            writer.println('=' * 80)
            writer.println()

            def fileCount = 0

            projectRoot.eachFileRecurse { file ->
                if (file.isDirectory()) return

                def relativePath = projectRoot.toPath().relativize(file.toPath()).toString()
                def pathParts = relativePath.split(/[\\\/]/)

                if (pathParts.any { excludeDirs.contains(it) }) return

                def extension = file.name.lastIndexOf('.') >= 0 ?
                               file.name.substring(file.name.lastIndexOf('.')) : ''

                if (!includeExtensions.contains(extension) &&
                    !['docker-compose.yml', 'Dockerfile'].contains(file.name)) {
                    return
                }

                try {
                    writer.println()
                    writer.println('-' * 80)
                    writer.println("–§–∞–π–ª: ${relativePath}")
                    writer.println('-' * 80)
                    writer.println(file.text)
                    if (!file.text.endsWith('\n')) {
                        writer.println()
                    }

                    fileCount++
                    println("‚úì –û–±—Ä–∞–±–æ—Ç–∞–Ω: ${relativePath}")

                } catch (Exception e) {
                    println("‚úó –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ ${relativePath}: ${e.message}")
                    writer.println("[–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${e.message}]")
                }
            }

            writer.println()
            writer.println('=' * 80)
            writer.println('–°–¢–ê–¢–ò–°–¢–ò–ö–ê')
            writer.println('=' * 80)
            writer.println("–í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${fileCount}")
            writer.println("–î–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${new Date().format('yyyy-MM-dd HH:mm:ss')}")
        }

        println()
        println("‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!")
        println("üìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: ${outputFile.name}")
        println()
        println("üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª ${outputFile.name} –≤ —á–∞—Ç")
    }
}